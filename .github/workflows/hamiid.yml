name: Windows RDP Optimized
on: workflow_dispatch

jobs:
  build:
    runs-on: windows-latest
    steps:

      # ============================================================
      # 1. Create User "hamid" + RDP Setup
      # ============================================================
      - name: Enable RDP + Create User
        shell: powershell
        run: |

          # Strong password (REPLACE WITH SECRET: secrets.RDP_PASSWORD)
          $password = "Hamid1212@"
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force

          # Create/update user
          if (Get-LocalUser -Name "hamid" -ErrorAction SilentlyContinue) {
              Set-LocalUser -Name "hamid" -Password $securePass
          } else {
              New-LocalUser -Name "hamid" -Password $securePass -AccountNeverExpires:$true
          }

          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "hamid"

          # Enable RDP in registry
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\' `
              -Name "fDenyTSConnections" -Value 0

          # RDP encryption fix for GH runners
          Set-ItemProperty `
            -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
            -Name "SecurityLayer" -Value 0 -Force

          # Firewall rule
          netsh advfirewall firewall delete rule name="RDP-Tailscale"
          netsh advfirewall firewall add rule name="RDP-Tailscale" dir=in action=allow protocol=TCP localport=3389


      # ============================================================
      # 2. Performance Optimization
      # ============================================================
      - name: Performance Boost
        shell: powershell
        run: |

          Write-Host "Applying Performance Optimizations..."

          # Prefer high performance power plan
          powercfg /setactive SCHEME_MIN

          # Increase system responsiveness
          reg add "HKLM\SYSTEM\CurrentControlSet\Control\PriorityControl" /v Win32PrioritySeparation /t REG_DWORD /d 26 /f

          # Enable disk write caching
          reg add "HKLM\SYSTEM\CurrentControlSet\Services\Disk" /v TimeOutValue /t REG_DWORD /d 0x0000003c /f

          # Network throughput optimization
          netsh interface tcp set global autotuninglevel=experimental
          netsh interface tcp set global rss=enabled
          netsh interface tcp set global rsc=enabled

          Write-Host "Performance Tweaks Applied."


      # ============================================================
      # 3. Install Tailscale + Connect
      # ============================================================
      - name: Install & Connect Tailscale
        shell: powershell
        run: |

          # Install Tailscale silently
          Start-Process msiexec.exe -ArgumentList '/i https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe /quiet' -Wait

          # Connect using your AUTH KEY
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up `
            --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} `
            --hostname=gh-runner-$env:GITHUB_RUN_ID

          # Detect IP
          $tsIP = $null
          for ($i=0; $i -lt 15 -and -not $tsIP; $i++) {
              Start-Sleep 2
              $tsIP = (& "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4).Trim()
          }

          if (-not $tsIP) { Write-Host "âŒ Tailscale IP could not be retrieved."; exit 1 }
          Write-Host "Tailscale IP: $tsIP"

          # Write credentials to console (safe for self-use)
          Write-Host ""
          Write-Host "==================== RDP INFORMATION ===================="
          Write-Host "Connect using any RDP client:"
          Write-Host ""
          Write-Host "IP Address : $tsIP:3389"
          Write-Host "Username   : hamid"
          Write-Host "Password   : Hamid1212@"
          Write-Host "========================================================="
          Write-Host ""


      # ============================================================
      # 4. Keep GitHub Runner Alive Forever
      # ============================================================
      - name: Keep Session Alive
        run: |
          echo "RDP session active. Workflow will stay alive."
          ping -t 127.0.0.1 > nul
