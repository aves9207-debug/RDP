name: RDP

on:
  workflow_dispatch:

jobs:
  rdp-job:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: Create RDP User
        shell: powershell
        run: |
          $password = "Hamid@1212" | ConvertTo-SecureString -AsPlainText -Force
          New-LocalUser -Name "Hamid" -Password $password -AccountNeverExpires:$true
          Add-LocalGroupMember -Group "Administrators" -Member "Hamid"

      - name: Enable RDP
        shell: powershell
        run: |
          # Enable RDP service
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0 -Force

          # Allow RDP through firewall
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

          # Enable RDP service
          Set-Service -Name TermService -StartupType Automatic

      - name: Disable NLA & Apply RDP Tweaks (No Errors)
        shell: powershell
        run: |
          # Disable NLA
          Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" `
                           -Name "UserAuthentication" -Value 0 -Force

          # Create missing registry paths
          if (-Not (Test-Path "HKLM:\SYSTEM\CurrentControlSet\Control\RDP")) {
              New-Item -Path "HKLM:\SYSTEM\CurrentControlSet\Control\RDP" -Force | Out-Null
          }

          if (-Not (Test-Path "HKLM:\SYSTEM\CurrentControlSet\Control\RDP\SessionImageQuality")) {
              New-Item -Path "HKLM:\SYSTEM\CurrentControlSet\Control\RDP\SessionImageQuality" -Force | Out-Null
          }

          # High quality RDP settings
          New-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\RDP\SessionImageQuality" `
                           -Name "EnableLossless" -Value 1 -PropertyType DWORD -Force
          New-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\RDP\SessionImageQuality" `
                           -Name "MinCompression" -Value 0 -PropertyType DWORD -Force
          New-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\RDP\SessionImageQuality" `
                           -Name "MaxCompression" -Value 0 -PropertyType DWORD -Force

      - name: GPU Optimization (Better for gaming & emulators)
        shell: powershell
        run: |
          # Enable GPU scheduling
          Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\GraphicsDrivers\Scheduler" `
                           -Name "EnableGpuScheduling" -Value 2 -Type DWord -Force

          # Improve DirectX rendering
          Set-ItemProperty -Path "HKLM:\Software\Microsoft\DirectX" `
                           -Name "MaxFrameLatency" -Value 1 -Type DWord -Force

          # RemoteFX improvements
          Set-ItemProperty -Path "HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services" `
                           -Name "UseAdvancedRemoteFXCodec" -Value 1 -Type DWord -Force

      - name: Start RDP Session Output
        shell: powershell
        run: |
          Write-Host "========================================"
          Write-Host "RDP is ready!"
          Write-Host "Username: Hamid"
          Write-Host "Password: Hamid@1212"
          Write-Host "Connect using Windows Remote Desktop."
          Write-Host "========================================"

      - name: Keep Session Alive
        shell: powershell
        run: |
          while ($true) { Start-Sleep -Seconds 300 }
