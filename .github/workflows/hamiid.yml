name: Gaming RDP (Stable Final)

on:
  workflow_dispatch:

jobs:
  gaming-rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
    - name: Enable RDP
      shell: powershell
      run: |
        Set-ItemProperty 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
          -Name fDenyTSConnections -Value 0 -Force
        Enable-NetFirewallRule -DisplayGroup 'Remote Desktop'
        Restart-Service TermService -Force

    - name: Create RDP User
      shell: powershell
      run: |
        $pass = ConvertTo-SecureString 'Hamid@12345' -AsPlainText -Force
        if (-not (Get-LocalUser Gamer -ErrorAction SilentlyContinue)) {
          New-LocalUser Gamer -Password $pass -PasswordNeverExpires
        }
        Add-LocalGroupMember Administrators Gamer -ErrorAction SilentlyContinue
        Add-LocalGroupMember 'Remote Desktop Users' Gamer -ErrorAction SilentlyContinue

    - name: Install VC++ Runtime
      shell: powershell
      run: |
        winget install Microsoft.VCRedist.2015+.x64 -e `
          --accept-source-agreements --accept-package-agreements

    - name: Prepare Emulator Folders
      shell: powershell
      run: |
        New-Item -ItemType Directory -Force -Path C:\Emulators | Out-Null
        New-Item -ItemType Directory -Force -Path C:\Switch\keys | Out-Null
        New-Item -ItemType Directory -Force -Path C:\Switch\games | Out-Null

    - name: Show RDP Info
      shell: powershell
      run: |
        $ip = Invoke-RestMethod https://api.ipify.org
        Write-Host "=============================="
        Write-Host "RDP READY"
        Write
