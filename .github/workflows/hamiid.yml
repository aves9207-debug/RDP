name: Gaming-RDP

on:
  workflow_dispatch:

jobs:
  rdp-server:
    runs-on: windows-2022
    timeout-minutes: 360

    steps:

    - name: Create RDP User
      shell: powershell
      run: |
        $password = "Hamid@12@"
        $securePass = ConvertTo-SecureString $password -AsPlainText -Force
        New-LocalUser -Name "gaming" -Password $securePass -AccountNeverExpires -PasswordNeverExpires
        Add-LocalGroupMember -Group "Administrators" -Member "gaming"

    - name: Enable RDP + Disable NLA
      shell: powershell
      run: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
          -Name "fDenyTSConnections" -Value 0 -Force

        # Disable NLA
        Set-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
          -Name "UserAuthentication" -Value 0 -Force

        # Enable RDP firewall
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

    - name: Apply Gaming Performance Tweaks (Fixes Your Error)
      shell: powershell
      run: |
        # Create required RDP registry folders (fixes path error)
        New-Item -Path "HKLM:\SYSTEM\CurrentControlSet\Control\RDP" -Force | Out-Null
        New-Item -Path "HKLM:\SYSTEM\CurrentControlSet\Control\RDP\SessionImageQuality" -Force | Out-Null

        # Max image quality
        New-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\RDP\SessionImageQuality" `
          -Name "EnableLossless" -Value 1 -PropertyType DWORD -Force

        New-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\RDP\SessionImageQuality" `
          -Name "MinCompression" -Value 0 -PropertyType DWORD -Force

        New-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\RDP\SessionImageQuality" `
          -Name "MaxCompression" -Value 0 -PropertyType DWORD -Force

        # Unlock GPU WARP (best possible on GitHub servers)
        Set-ItemProperty -Path 'HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Windows' `
          -Name "EnableWARP" -Value 1 -Force

        # Ultimate performance mode
        powercfg -duplicatescheme e9a42b02-d5df-448d-aa00-03f14749eb61
        powercfg -setactive e9a42b02-d5df-448d-aa00-03f14749eb61

    - name: Show RDP Info
      shell: powershell
      run: |
        Write-Host " "
        Write-Host "==============================="
        Write-Host "        RDP READY!"
        Write-Host "==============================="
        Write-Host "Username: gaming"
        Write-Host "Password: Hamid@12@"
        Write-Host "Use this IP in Remote Desktop:"
        ipconfig
        Write-Host "==============================="
        Write-Host " "
