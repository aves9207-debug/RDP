name: Gaming RDP (Final Stable)

on:
  workflow_dispatch:

jobs:
  gaming-rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
    # ----------------------------------------------------
    # 1. Enable RDP (Safe)
    # ----------------------------------------------------
    - name: Enable RDP
      shell: powershell
      run: |
        Write-Host "Enabling RDP..."
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
          -Name 'fDenyTSConnections' -Value 0 -Force
        Enable-NetFirewallRule -DisplayGroup 'Remote Desktop'
        Restart-Service TermService -Force
        Write-Host "RDP enabled"

    # ----------------------------------------------------
    # 2. Create RDP User (PARSER SAFE)
    # ----------------------------------------------------
    - name: Create RDP User
      shell: powershell
      run: |
        Write-Host "Creating user..."

        $SecurePass = ConvertTo-SecureString 'Hamid@12345' -AsPlainText -Force

        $ExistingUser = Get-LocalUser -Name 'Gamer' -ErrorAction SilentlyContinue
        if ($null -eq $ExistingUser) {
          New-LocalUser -Name 'Gamer' `
            -Password $SecurePass `
            -AccountNeverExpires `
            -PasswordNeverExpires
        }

        Add-LocalGroupMember -Group 'Administrators' -Member 'Gamer' -ErrorAction SilentlyContinue
        Add-LocalGroupMember -Group 'Remote Desktop Users' -Member 'Gamer' -ErrorAction SilentlyContinue

        Write-Host "User Gamer ready"

    # ----------------------------------------------------
    # 3. Install VC++ Runtime (Non-fatal)
    # ----------------------------------------------------
    - name: Install VC++ Runtime
      shell: powershell
      run: |
        Write-Host "Installing VC++ Runtime..."
        winget install --id Microsoft.VCRedist.2015+.x64 -e `
          --accept-source-agreements --accept-package-agreements
        Write-Host "VC++ OK"

    # ----------------------------------------------------
    # 4. Install Ryujinx (NO 404 EVER)
    # ----------------------------------------------------
    - name: Install Ryujinx Emulator
      shell: powershell
      run: |
        Write-Host "Installing Chocolatey..."
        Set-ExecutionPolicy Bypass -Scope Process -Force
        [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
        iex ((New-Object Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))

        Write-Host "Installing Ryujinx..."
        choco install ryujinx -y --no-progress

        New-Item -ItemType Directory -Force -Path 'C:\Switch\keys' | Out-Null
        New-Item -ItemType Directory -Force -Path 'C:\Switch\games' | Out-Null

        Write-Host "Ryujinx installed successfully"

    # ----------------------------------------------------
    # 5. Show RDP Info
    # ----------------------------------------------------
    - name: Show RDP Info
      shell: powershell
      run: |
        $ip = Invoke-RestMethod https://api.ipify.org
        Write-Host "================================"
        Write-Host "RDP READY"
        Write-Host "IP       : $ip"
        Write-Host "USER     : Gamer"
        Write-Host "PASS     : Hamid@12345"
        Write-Host "Ryujinx  : C:\Program Files\Ryujinx\Ryujinx.exe"
        Write-Host "Keys     : C:\Switch\keys"
        Write-Host "Games    : C:\Switch\games"
        Write-Host "================================"

    # ----------------------------------------------------
    # 6. Keep Session Alive
    # ----------------------------------------------------
    - name: Keep RDP Alive
      shell: powershell
      run: |
        while ($true) {
          Write-Host "RDP running..."
          Start-Sleep 300
        }
