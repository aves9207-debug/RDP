name: RDP - Gaming (windows-latest)

on:
  workflow_dispatch:

jobs:
  gaming-rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:

    - name: Show baseline info
      shell: powershell
      run: |
        Write-Host "Runner info"
        Get-ComputerInfo | Select CsName, WindowsProductName, WindowsVersion
        Get-PSDrive C | Select Used,Free

    # ---------------------------
    # Free disk & cleanup (safe)
    # ---------------------------
    - name: Free Up Disk Space (safe)
      shell: powershell
      run: |
        Write-Host "Cleaning caches..."
        $paths = @("C:\Android","C:\hostedtoolcache\CodeQL","C:\hostedtoolcache\go")
        foreach ($p in $paths) { if (Test-Path $p) { Remove-Item $p -Recurse -Force -ErrorAction SilentlyContinue } }
        if (Test-Path "C:\hostedtoolcache\Python") {
          Get-ChildItem "C:\hostedtoolcache\Python" | Where-Object { $_.Name -notlike "*3.12*" } | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
        }
        Remove-Item "$env:TEMP\*" -Recurse -Force -ErrorAction SilentlyContinue
        Stop-Service wuauserv -Force -ErrorAction SilentlyContinue
        Remove-Item "C:\Windows\SoftwareDistribution\Download\*" -Recurse -Force -ErrorAction SilentlyContinue
        Start-Service wuauserv -ErrorAction SilentlyContinue
        Get-PSDrive C | Select Used,Free

    # ---------------------------
    # Enable RDP & firewall
    # ---------------------------
    - name: Enable RDP
      shell: powershell
      run: |
        Write-Host "Enabling RDP..."
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -ErrorAction SilentlyContinue
        # Make sure the firewall rules for Remote Desktop are enabled
        try { Enable-NetFirewallRule -DisplayGroup "Remote Desktop" -ErrorAction SilentlyContinue } catch {}
        Restart-Service -Name TermService -Force -ErrorAction SilentlyContinue

    # ---------------------------
    # Create RDP user (stable)
    # ---------------------------
    - name: Create RDP User
      shell: powershell
      run: |
        $username = "RDP"
        # Strong Windows-approved password (change if you want)
        $password = "Hamid@1234!"
        $secure = ConvertTo-SecureString $password -AsPlainText -Force
        if (-not (Get-LocalUser -Name $username -ErrorAction SilentlyContinue)) {
          New-LocalUser -Name $username -Password $secure -AccountNeverExpires -ErrorAction SilentlyContinue
        } else {
          Write-Host "User $username already exists - skipping creation."
        }
        Add-LocalGroupMember -Group "Administrators" -Member $username -ErrorAction SilentlyContinue
        Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username -ErrorAction SilentlyContinue
        Add-Content $env:GITHUB_ENV "RDP_USER=$username"
        Add-Content $env:GITHUB_ENV "RDP_PASS=$password"

    # ---------------------------
    # Power plan: Ultimate Performance
    # ---------------------------
    - name: Set Ultimate Performance Power Plan
      shell: powershell
      run: |
        Write-Host "Setting Ultimate Performance power plan (if available)..."
        $guid = "e9a42b02-d5df-448d-aa00-03f14749eb61"
        try {
          # Duplicate scheme (some images don't have it by default)
          $dup = powercfg -duplicatescheme $guid 2>&1
        } catch {}
        # Try to set active; if it fails silently continue
        try { powercfg -setactive $guid } catch {}
        Write-Host "Active power plan:"
        powercfg /getactivescheme

    # ---------------------------
    # Game / multimedia tuning (registry tweaks)
    # ---------------------------
    - name: Apply multimedia / game tuning
      shell: powershell
      run: |
        Write-Host "Applying multimedia / responsiveness tweaks..."
        $base = 'HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Multimedia\SystemProfile'
        New-Item -Path $base -Force -ErrorAction SilentlyContinue | Out-Null

        # Favor performance for multimedia
        New-ItemProperty -Path $base -Name "SystemResponsiveness" -Value 0 -PropertyType DWord -Force -ErrorAction SilentlyContinue
        New-ItemProperty -Path $base -Name "NetworkThrottlingIndex" -Value 0 -PropertyType DWord -Force -ErrorAction SilentlyContinue
        # Boost priority for "Games" tasks (best-effort)
        $tasksPath = "$base\Tasks\Games"
        New-Item -Path $tasksPath -Force -ErrorAction SilentlyContinue | Out-Null
        New-ItemProperty -Path $tasksPath -Name "GPU Priority" -Value 8 -PropertyType DWord -Force -ErrorAction SilentlyContinue
        New-ItemProperty -Path $tasksPath -Name "Priority" -Value 6 -PropertyType DWord -Force -ErrorAction SilentlyContinue
        New-ItemProperty -Path $tasksPath -Name "Scheduling Category" -Value 2 -PropertyType DWord -Force -ErrorAction SilentlyContinue

    # ---------------------------
    # Stop some non-essential services (safe)
    # ---------------------------
    - name: Stop non-essential services (safe)
      shell: powershell
      run: |
        $toStop = @("SysMain","DiagTrack","WSearch")
        foreach ($svc in $toStop) {
          try { Stop-Service -Name $svc -ErrorAction SilentlyContinue } catch {}
          try { Set-Service -Name $svc -StartupType Disabled -ErrorAction SilentlyContinue } catch {}
        }
        Get-Service | Where-Object { $_.Status -eq 'Running' -and ($toStop -contains $_.Name) } | Select Name, Status

    # ---------------------------
    # Network TCP tuning (best-effort)
    # ---------------------------
    - name: Network tuning
      shell: powershell
      run: |
        Write-Host "Applying conservative TCP tuning..."
        try { netsh interface tcp set global autotuninglevel=normal congestionprovider=ctcp | Out-Null } catch {}
        try { netsh int tcp set supplemental template=default | Out-Null } catch {}
        # reduce DNS lookup timeouts (best-effort)
        try { Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\Dnscache\Parameters" -Name "NegativeCacheTime" -Value 5 -Type DWord -Force -ErrorAction SilentlyContinue } catch {}

    # ---------------------------
    # Install Tailscale (for RDP tunnel)
    # ---------------------------
    - name: Install Tailscale
      shell: powershell
      run: |
        $url = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
        $out = "$env:TEMP\tailscale.msi"
        Invoke-WebRequest -Uri $url -OutFile $out -ErrorAction SilentlyContinue
        Start-Process -FilePath "msiexec.exe" -ArgumentList "/i `"$out`" /quiet /norestart" -Wait -NoNewWindow -ErrorAction SilentlyContinue

    - name: Connect Tailscale
      shell: powershell
      env:
        TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      run: |
        $exe = "$env:ProgramFiles\Tailscale\tailscale.exe"
        if (Test-Path $exe) {
          & $exe up --authkey=$env:TAILSCALE_AUTH_KEY --hostname "gh-runner-${{ github.run_id }}" -wait 2>&1 | Write-Host
          $ip = & $exe ip -4 2>$null
          if ($ip) { Add-Content $env:GITHUB_ENV "TS_IP=$ip" } else { Write-Host "Tailscale IP not detected yet." }
        } else {
          Write-Host "Tailscale exe not found - install may have failed."
        }

    # ---------------------------
    # Optional: Install SteamCMD (headless) - useful for testing & downloading games
    # ---------------------------
    - name: Install SteamCMD (optional)
      shell: powershell
      run: |
        Write-Host "Installing SteamCMD (optional headless client)..."
        $scDir = "$env:ProgramFiles\steamcmd"
        New-Item -ItemType Directory -Path $scDir -Force -ErrorAction SilentlyContinue | Out-Null
        $zip = "$env:TEMP\steamcmd.zip"
        try {
          Invoke-WebRequest "https://steamcdn-a.akamaihd.net/client/installer/steamcmd.zip" -OutFile $zip -ErrorAction SilentlyContinue
          Expand-Archive -Path $zip -DestinationPath $scDir -Force -ErrorAction SilentlyContinue
        } catch { Write-Host "SteamCMD download failed or blocked." }

    # ---------------------------
    # Final diagnostics & keep alive
    # ---------------------------
    - name: Show Connection & Perf Info
      shell: powershell
      run: |
        Write-Host "`n================= STATUS ================="
        Write-Host "RDP user: $env:RDP_USER"
        Write-Host "RDP pass: $env:RDP_PASS"
        Write-Host "Tailscale IP: $env:TS_IP"
        $d = Get-PSDrive C
        Write-Host "Disk (GB) Total: $([math]::Round(($d.Free+$d.Used)/1GB,2)) Used: $([math]::Round($d.Used/1GB,2)) Free: $([math]::Round($d.Free/1GB,2))"
        Write-Host "Active power scheme:"
        powercfg /getactivescheme
        Write-Host "Multimedia / Game registry values:"
        Get-ItemProperty -Path 'HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Multimedia\SystemProfile' | Format-List

    - name: Keep Alive (maintain runner session)
      shell: powershell
      run: |
        while ($true) {
          Write-Host "[$(Get-Date -Format o)] Runner alive for gaming RDP..."
          Start-Sleep -Seconds 300
        }
