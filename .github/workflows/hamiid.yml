name: RDP

on:
  workflow_dispatch:

jobs:
  rdp-job:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
    # ------------------------------------------------------------
    # FREE DISK SPACE
    # ------------------------------------------------------------
    - name: Free Up Disk Space
      shell: powershell
      run: |
        Write-Host "Disk Before:"
        Get-PSDrive C | Select Used,Free

        # Remove Android
        if (Test-Path "C:\Android") {
          Remove-Item "C:\Android" -Recurse -Force
        }

        # Remove CodeQL
        if (Test-Path "C:\hostedtoolcache\CodeQL") {
          Remove-Item "C:\hostedtoolcache\CodeQL" -Recurse -Force
        }

        # Remove old Pythons
        if (Test-Path "C:\hostedtoolcache\Python") {
          Get-ChildItem "C:\hostedtoolcache\Python" |
            Where-Object { $_.Name -notlike "*3.12*" } |
            Remove-Item -Recurse -Force
        }

        # Temporary Files
        Remove-Item "$env:TEMP\*" -Recurse -Force -ErrorAction SilentlyContinue
        Remove-Item "C:\Windows\Temp\*" -Recurse -Force -ErrorAction SilentlyContinue

        # Windows Update Cleanup
        Stop-Service wuauserv -Force -ErrorAction SilentlyContinue
        Remove-Item "C:\Windows\SoftwareDistribution\Download\*" -Recurse -Force
        Start-Service wuauserv -ErrorAction SilentlyContinue

        Write-Host "Disk After:"
        Get-PSDrive C | Select Used,Free


    # ------------------------------------------------------------
    # ENABLE RDP
    # ------------------------------------------------------------
    - name: Enable RDP
      shell: powershell
      run: |
        Set-ItemProperty "HKLM:\System\CurrentControlSet\Control\Terminal Server" "fDenyTSConnections" 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Restart-Service TermService -Force


    # ------------------------------------------------------------
    # CREATE RDP USER
    # ------------------------------------------------------------
    - name: Create RDP User
      shell: powershell
      run: |
        $password = ConvertTo-SecureString "Hamid@1212" -AsPlainText -Force
        New-LocalUser -Name "Hamid" -Password $password -AccountNeverExpires
        Add-LocalGroupMember -Group "Administrators" -Member "Hamid"
        Add-LocalGroupMember -Group "Remote Desktop Users" -Member "Hamid"

        echo "RDP_USER=Hamid" >> $env:GITHUB_ENV
        echo "RDP_PASS=Hamid@1212" >> $env:GITHUB_ENV


    # ------------------------------------------------------------
    # DISABLE NLA + RDP QUALITY BOOST
    # ------------------------------------------------------------
    - name: Disable NLA and Apply RDP Tweaks
      shell: powershell
      run: |
        # Disable NLA
        Set-ItemProperty `
          -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" `
          -Name "UserAuthentication" `
          -Value 0 -Force

        # Create RDP registry path safely
        if (-Not (Test-Path "HKLM:\SYSTEM\CurrentControlSet\Control\RDP")) {
          New-Item "HKLM:\SYSTEM\CurrentControlSet\Control\RDP" -Force | Out-Null
        }
        if (-Not (Test-Path "HKLM:\SYSTEM\CurrentControlSet\Control\RDP\SessionImageQuality")) {
          New-Item "HKLM:\SYSTEM\CurrentControlSet\Control\RDP\SessionImageQuality" -Force | Out-Null
        }

        # HIGH QUALITY RDP
        New-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\RDP\SessionImageQuality" `
                         -Name "EnableLossless" -Value 1 -PropertyType DWORD -Force

        New-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\RDP\SessionImageQuality" `
                         -Name "MinCompression" -Value 0 -PropertyType DWORD -Force

        New-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\RDP\SessionImageQuality" `
                         -Name "MaxCompression" -Value 0 -PropertyType DWORD -Force


    # ------------------------------------------------------------
    # INSTALL TAILSCALE
    # ------------------------------------------------------------
    - name: Install Tailscale
      shell: powershell
      run: |
        $url = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
        $out = "$env:TEMP\tailscale.msi"
        Invoke-WebRequest $url -OutFile $out
        Start-Process msiexec.exe -ArgumentList "/i $out /quiet /norestart" -Wait


    # ------------------------------------------------------------
    # CONNECT TAILSCALE
    # ------------------------------------------------------------
    - name: Connect Tailscale
      shell: powershell
      run: |
        & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }}
        $ip = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
        echo "TS_IP=$ip" >> $env:GITHUB_ENV


    # ------------------------------------------------------------
    # SHOW CONNECTION INFO
    # ------------------------------------------------------------
    - name: Show Info
      shell: powershell
      run: |
        Write-Host "`n====================================="
        Write-Host "       RDP SERVER READY"
        Write-Host "-------------------------------------"
        Write-Host "Connect to → $env:TS_IP"
        Write-Host "Username   → $env:RDP_USER"
        Write-Host "Password   → $env:RDP_PASS"
        Write-Host "=====================================`n"


    # ------------------------------------------------------------
    # KEEP ALIVE
    # ------------------------------------------------------------
    - name: Keep Alive
      shell: powershell
      run: |
        while ($true) {
          Write-Host "[$(Get-Date)] Running..."
          Start-Sleep -Seconds 300
        }
