name: Gaming RDP + Ryujinx (No Powercfg)
on:
  workflow_dispatch:

jobs:
  rdp-gaming:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
    # ----------------------------------------------------------
    # SAFE PERFORMANCE SECTION (NO POWERCMD)
    # ----------------------------------------------------------
    - name: Performance Tweaks
      shell: powershell
      run: |
        Write-Host "GitHub Runner blocks all powercfg changes."
        Write-Host "Skipping power settings. System already on High Performance."

    # ----------------------------------------------------------
    # ENABLE RDP
    # ----------------------------------------------------------
    - name: Enable RDP
      shell: powershell
      run: |
        Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" `
          -Name "fDenyTSConnections" -Value 0 -Force
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Restart-Service TermService -Force

    # ----------------------------------------------------------
    # CREATE RDP USER
    # ----------------------------------------------------------
    - name: Create RDP User
      shell: powershell
      run: |
        $password = "Hamid@12345"
        $securePass = ConvertTo-SecureString $password -AsPlainText -Force

        if (-not (Get-LocalUser -Name "Gamer" -ErrorAction SilentlyContinue)) {
          New-LocalUser -Name "Gamer" -Password $securePass -AccountNeverExpires
        }

        Add-LocalGroupMember -Group "Administrators" -Member "Gamer" -ErrorAction SilentlyContinue
        Add-LocalGroupMember -Group "Remote Desktop Users" -Member "Gamer" -ErrorAction SilentlyContinue

        echo "PASS=$password" >> $env:GITHUB_ENV

    # ----------------------------------------------------------
    # INSTALL TAILSCALE
    # ----------------------------------------------------------
    - name: Install Tailscale
      shell: powershell
      run: |
        Invoke-WebRequest "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi" -OutFile "ts.msi"
        Start-Process msiexec.exe -ArgumentList "/i ts.msi /quiet /norestart" -Wait

    - name: Connect Tailscale
      shell: powershell
      run: |
        $ts = "$env:ProgramFiles\Tailscale\tailscale.exe"
        & $ts up --authkey "${{ secrets.TAILSCALE_AUTH_KEY }}" --hostname "Ryujinx-RDP"
        $ip = & $ts ip -4
        echo "TSIP=$ip" >> $env:GITHUB_ENV

    # ----------------------------------------------------------
    # INSTALL RYUJINX EMULATOR
    # ----------------------------------------------------------
    - name: Install Ryujinx
      shell: powershell
      run: |
        mkdir C:\Ryujinx -Force
        Invoke-WebRequest "https://github.com/Ryujinx/release-channel-master/releases/latest/download/ryujinx-win_x64.zip" -OutFile "ryujinx.zip"
        Expand-Archive ryujinx.zip -DestinationPath C:\Ryujinx -Force

        mkdir C:\Switch -Force
        mkdir C:\Switch\keys -Force
        mkdir C:\Switch\games -Force

        Write-Host "Upload prod.keys + title.keys -> C:\\Switch\\keys"
        Write-Host "Upload your game NSP/XCI -> C:\\Switch\\games"

    # ----------------------------------------------------------
    # SHOW INFO (CREDENTIALS + PATHS)
    # ----------------------------------------------------------
    - name: Show Info
      shell: powershell
      run: |
        Write-Host "==========================="
        Write-Host "Tailscale IP: $env:TSIP"
        Write-Host "RDP User: Gamer"
        Write-Host "RDP Pass: $env:PASS"
        Write-Host "Ryujinx Path: C:\\Ryujinx"
        Write-Host "Games Folder: C:\\Switch\\games"
        Write-Host "Keys Folder: C:\\Switch\\keys"
        Write-Host "==========================="

    # ----------------------------------------------------------
    # KEEP ALIVE
    # ----------------------------------------------------------
    - name: Keep Alive
      shell: powershell
      run: |
        while ($true) {
          Write-Host "RDP Running..."
          Start-Sleep -Seconds 300
        }
