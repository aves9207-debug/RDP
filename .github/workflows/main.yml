name: Gaming RDP Setup on Windows 2022

on:
  workflow_dispatch:

jobs:
  setup-gaming-rdp:
    runs-on: windows-2022

    steps:
    - name: Create RDP User with Fixed Password
      shell: powershell
      run: |
        $password = "hamid1212@"
        $securePass = ConvertTo-SecureString $password -AsPlainText -Force

        if (Get-LocalUser -Name "RDP" -ErrorAction SilentlyContinue) {
          Remove-LocalUser -Name "RDP"
        }

        New-LocalUser -Name "RDP" -Password $securePass -PasswordNeverExpires:$true
        Add-LocalGroupMember -Group "Administrators" -Member "RDP"

    - name: Configure RDP and Firewall
      shell: powershell
      run: |
        # Disable NLA for RDP
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force

        # Allow Font Smoothing and 32-bit color for better graphics
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "AllowFontSmoothing" -Value 1 -Force
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "ColorDepth" -Value 32 -Force

        # Enable advanced RDP codec (AVC/H264)
        New-ItemProperty -Path "HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services" -Name "UseAdvancedRemoteFXCodec" -PropertyType DWord -Value 1 -Force

        # Enable hardware encoding if GPU available
        New-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\RDP\SessionImageQuality" -Name "EnableHWEncoder" -PropertyType DWord -Value 1 -Force

        # Remove old firewall rule if exists and add new RDP rule for Tailscale
        netsh advfirewall firewall delete rule name="RDP-Tailscale"
        netsh advfirewall firewall add rule name="RDP-Tailscale" dir=in action=allow protocol=TCP localport=3389

    - name: Optimize Windows for Gaming RDP Performance
      shell: powershell
      run: |
        # Set High Performance power plan
        powercfg -duplicatescheme e9a42b02-d5df-448d-aa00-03f14749eb61
        powercfg -setactive e9a42b02-d5df-448d-aa00-03f14749eb61

        # Disable SysMain (Superfetch) to reduce background CPU use
        Stop-Service SysMain -Force
        Set-Service SysMain -StartupType Disabled

        # Disable mouse smoothing for better responsiveness
        reg add "HKCU\Control Panel\Mouse" /v MouseFilter /t REG_DWORD /d 0 /f

        # TCP Optimizations for low latency
        netsh interface tcp set global autotuninglevel=normal
        netsh interface tcp set global timestamps=disabled
        netsh interface tcp set global rsc=disabled

    - name: Install VC++ Redistributable (Optional, uncomment if needed)
      shell: powershell
      run: |
        # Uncomment these lines if your games require VC++ redistributable
        # Invoke-WebRequest "https://aka.ms/vs/17/release/vc_redist.x64.exe" -OutFile vc.exe
        # Start-Process -FilePath .\vc.exe -ArgumentList "/quiet" -Wait

    - name: Start Tailscale with Auth Key and Hostname
      shell: powershell
      env:
        TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      run: |
        Start-Process -FilePath "$env:ProgramFiles\Tailscale\tailscale.exe" -ArgumentList "up --authkey=$env:TAILSCALE_AUTH_KEY --hostname=gh-runner-$env:GITHUB_RUN_ID" -Wait

        # Wait for Tailscale IPv4 to appear
        $tsIP = $null
        for ($i=0; $i -lt 10 -and -not $tsIP; $i++) {
          $tsIP = (& "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4).Trim()
          Start-Sleep -Seconds 2
        }

        Write-Host "Tailscale IPv4: $tsIP"
